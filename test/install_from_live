#!/usr/bin/env bash

set -xeuo pipefail

export PATH="/root/arch-ostree:$PATH"

disk="/dev/disk/by-id/ata-QEMU_HARDDISK_QM00002"
part_efi="/dev/disk/by-partlabel/efi"
part_boot="/dev/disk/by-partlabel/boot"
part_root="/dev/disk/by-partlabel/root"

prepare() {
	umount -R /mnt || true

	sfdisk -w always "$disk" < "/root/arch-ostree/test/layout.sfdisk"
	sleep 1

	mkfs.vfat -F32 "$part_efi"
	mkfs.ext4 "$part_boot"
	mkfs.ext4 "$part_root"

	mount "$part_root" /mnt

	mkdir /mnt/boot
	mount "$part_boot" /mnt/boot

	mkdir /mnt/boot/efi
	mount "$part_efi" /mnt/boot/efi

	arch-ostree prepare_live_env

	ostree admin init-fs --sysroot /mnt --modern /mnt
	ostree admin stateroot-init --sysroot /mnt archlinux
	ostree config --repo /mnt/ostree/repo set sysroot.bootprefix 1
}

deploy_cmd() {
	arch-ostree \
		--rootfs-dir /mnt/setup/deployment \
		--boot-dir /mnt/boot \
		--sysroot-dir /mnt \
		deploy_initial -- "$@"
}

prepare
arch-ostree build_builder_container

arch-ostree \
	--pacman-cache /mnt/setup/pacman_cache \
	--rootfs-dir /mnt/setup/rootfs \
	build_rootfs_directory \
	/root/arch-ostree/test/build_rootfs.sh

arch-ostree \
 	--rootfs-dir /mnt/setup/rootfs \
	--ostree-repo /mnt/ostree/repo \
	commit_rootfs_directory \
	-- -v -b test

rm -rf /mnt/setup/deployment
ostree checkout \
	--repo /mnt/ostree/repo \
	--require-hardlinks \
	test /mnt/setup/deployment

deploy_cmd grub-install \
	--target x86_64-efi \
	--efi-directory /boot/efi \
	--boot-directory /boot/efi/EFI \
	--bootloader-id=GRUB \
	--removable

touch /mnt/boot/efi/EFI/grub/grub.cfg
rootuuid="$(blkid -o value -s UUID "$part_root")"
deploy_cmd ostree admin deploy \
	--os=archlinux \
	--no-merge \
	--karg-none \
	--karg=root=UUID="$rootuuid" \
	--karg=rw \
	test

install -d /mnt/ostree/deploy/archlinux/var/roothome/.ssh
install -m 0644 "/tmp/id_rsa.pub" /mnt/ostree/deploy/archlinux/var/roothome/.ssh/authorized_keys

genfstab -U /mnt >> /mnt/ostree/deploy/archlinux/deploy/*/etc/fstab
